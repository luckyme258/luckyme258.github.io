name: æ›´æ–°ä¹¦ç±åˆ—è¡¨

on:
  push:
    paths:
      - 'books4me/*.html'              # åªè¦æœ‰æ–°ä¹¦ä¸Šä¼ å°±è§¦å‘
      - 'books4me/**/*.html'           # åŒ…æ‹¬å­ç›®å½•
  workflow_dispatch:                 # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *'           # æ¯6å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼ˆå¤‡ç”¨ï¼‰

jobs:
  update-books-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write                # å…è®¸å†™å…¥ä»“åº“
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0              # è·å–å®Œæ•´å†å²ï¼Œç”¨äºè·å–æ–‡ä»¶ä¿®æ”¹æ—¶é—´
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ç”Ÿæˆä¹¦ç±åˆ—è¡¨
        run: |
          cat > generate_books.py << 'EOF'
          import os
          import json
          import time
          from datetime import datetime
          import glob
          
          def get_category_icon(category):
              """ä¸ºåˆ†ç±»åˆ†é…å›¾æ ‡"""
              icons = {
                  'ç«¥è¯': 'ğŸ§š',
                  'ç§‘å¹»': 'ğŸš€',
                  'æ–‡å­¦': 'ğŸ“š',
                  'å†å²': 'ğŸ›ï¸',
                  'å“²å­¦': 'ğŸ¤”',
                  'è¯—æ­Œ': 'ğŸ­',
                  'ä¼ è®°': 'ğŸ“œ',
                  'æŠ€æœ¯': 'ğŸ’»',
                  'è‰ºæœ¯': 'ğŸ¨',
                  'æ•™è‚²': 'ğŸ“–'
              }
              return icons.get(category, 'ğŸ“˜')
          
          def parse_filename(filename):
              """è§£ææ–‡ä»¶åï¼Œæå–åˆ†ç±»å’Œä¹¦å"""
              name = filename.replace('.html', '')
              
              # é»˜è®¤å€¼
              category = 'æœªåˆ†ç±»'
              title = name
              author = ''
              
              # è§£ææ ¼å¼ï¼šåˆ†ç±»_ä¹¦å_ä½œè€….html
              if '_' in name:
                  parts = name.split('_')
                  if len(parts) >= 2:
                      category = parts[0]
                      title = parts[1]
                  if len(parts) >= 3:
                      author = parts[2]
              
              return {
                  'category': category,
                  'title': title,
                  'author': author
              }
          
          def get_file_time(filepath):
              """è·å–æ–‡ä»¶çš„Gitæäº¤æ—¶é—´ï¼ˆæ›´å‡†ç¡®ï¼‰"""
              try:
                  # è·å–æœ€åä¸€æ¬¡gitæäº¤æ—¶é—´
                  import subprocess
                  result = subprocess.run(
                      ['git', 'log', '-1', '--format=%ct', filepath],
                      capture_output=True, text=True
                  )
                  if result.returncode == 0 and result.stdout.strip():
                      return int(result.stdout.strip()) * 1000
              except:
                  pass
              
              # é™çº§ä½¿ç”¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´
              return int(os.path.getmtime(filepath) * 1000)
          
          def main():
              books_dir = 'books4me'  # ä¿®æ­£ï¼šä¸è§¦å‘è·¯å¾„ä¿æŒä¸€è‡´
              # ç¡®ä¿ç›®å½•å­˜åœ¨
              if not os.path.exists(books_dir):
                  print(f"âš ï¸ ç›®å½• {books_dir} ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºç›®å½•")
                  os.makedirs(books_dir)
                  # å†™å…¥ç©ºçš„JSONæ–‡ä»¶é¿å…æäº¤é”™è¯¯
                  empty_data = {
                      'lastUpdated': int(time.time() * 1000),
                      'totalBooks': 0,
                      'totalCategories': 0,
                      'categories': [],
                      'books': [],
                      'categoryStats': []
                  }
                  with open(f'{books_dir}/books.json', 'w', encoding='utf-8') as f:
                      json.dump(empty_data, f, ensure_ascii=False, indent=2)
                  return
              
              all_books = []
              
              # æ‰«ææ‰€æœ‰HTMLæ–‡ä»¶ï¼ˆåŒ…æ‹¬å­ç›®å½•ï¼‰
              html_files = glob.glob(f'{books_dir}/**/*.html', recursive=True)
              
              for filepath in html_files:
                  filename = os.path.basename(filepath)
                  
                  # è·³è¿‡index.html
                  if filename == 'index.html':
                      continue
                  
                  # è·å–ç›¸å¯¹è·¯å¾„ï¼ˆç”¨äºé“¾æ¥ï¼‰
                  rel_path = os.path.relpath(filepath, books_dir).replace('\\', '/')
                  
                  # è§£ææ–‡ä»¶å
                  parsed = parse_filename(filename)
                  
                  # è·å–æ–‡ä»¶ä¿¡æ¯
                  stat = os.stat(filepath)
                  file_time = get_file_time(filepath)
                  
                  book = {
                      'id': filename,
                      'file': rel_path,                    # ç›¸å¯¹è·¯å¾„
                      'filename': filename,                 # åŸå§‹æ–‡ä»¶å
                      'title': parsed['title'],              # ä¹¦å
                      'category': parsed['category'],        # åˆ†ç±»
                      'author': parsed['author'],            # ä½œè€…
                      'size': stat.st_size,                  # æ–‡ä»¶å¤§å°
                      'lastModified': file_time,              # æœ€åä¿®æ”¹æ—¶é—´
                      'addedTime': file_time                   # æ·»åŠ æ—¶é—´
                  }
                  
                  all_books.append(book)
              
              # æŒ‰ä¹¦åæ’åº
              all_books.sort(key=lambda x: x['title'])
              
              # æŒ‰åˆ†ç±»ç»Ÿè®¡
              categories = {}
              for book in all_books:
                  cat = book['category']
                  if cat not in categories:
                      categories[cat] = []
                  categories[cat].append(book)
              
              # ç”Ÿæˆæœ€ç»ˆæ•°æ®
              output_data = {
                  'lastUpdated': int(time.time() * 1000),
                  'totalBooks': len(all_books),
                  'totalCategories': len(categories),
                  'categories': list(categories.keys()),
                  'books': all_books,
                  'categoryStats': [
                      {
                          'name': cat,
                          'count': len(books),
                          'icon': get_category_icon(cat)
                      }
                      for cat, books in categories.items()
                  ]
              }
              
              # å†™å…¥books.json
              with open(f'{books_dir}/books.json', 'w', encoding='utf-8') as f:
                  json.dump(output_data, f, ensure_ascii=False, indent=2)
              
              print(f'âœ… ç”Ÿæˆå®Œæˆï¼š{len(all_books)} æœ¬ä¹¦ï¼Œ{len(categories)} ä¸ªåˆ†ç±»')
          
          if __name__ == '__main__':
              main()
          EOF
          
          python3 generate_books.py
      
      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # æ‹‰å–æœ€æ–°ä»£ç ï¼Œé¿å…å†²çª
          git pull origin ${{ github.ref_name }} --rebase
          git add books4me/books.json
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹ï¼Œæœ‰åˆ™æäº¤
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ä¹¦ç±åˆ—è¡¨ [skip ci]"
          git push
