name: æ›´æ–°books4meç›®å½•ä¹¦ç±åˆ—è¡¨

on:
  push:
    branches: [main, master]
    paths:
      - 'books4me/*.html'
      - 'books4me/**/*.html'
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  update-books4me-list:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ä»…ä¿ç•™ï¼Œä¸å½±å“æ ¸å¿ƒé€»è¾‘

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ç”Ÿæˆä¹¦ç±åˆ—è¡¨JSONï¼ˆbooks4meï¼‰
        run: |
          mkdir -p books4me
          cat > generate_books4me.py << 'EOF'
          import os
          import json
          from datetime import datetime

          category_icons = {
              'ç«¥è¯': 'ğŸ§š', 'ç§‘å¹»': 'ğŸš€', 'æ–‡å­¦': 'ğŸ“š', 
              'å†å²': 'ğŸ›ï¸', 'å“²å­¦': 'ğŸ¤”', 'è¯—æ­Œ': 'ğŸ­',
              'ä¼ è®°': 'ğŸ“œ', 'æŠ€æœ¯': 'ğŸ’»', 'è‰ºæœ¯': 'ğŸ¨',
              'å°è¯´': 'ğŸ“–', 'æ•£æ–‡': 'âœï¸', 'ç§‘æ™®': 'ğŸ”¬',
              'å¿ƒç†å­¦': 'ğŸ§ ', 'ç»æµå­¦': 'ğŸ’°', 'ç®¡ç†å­¦': 'ğŸ“Š',
              'æœªåˆ†ç±»': 'ğŸ“˜'
          }

          target_dir = 'books4me'
          books = []
          category_stats = {}

          for filename in os.listdir(target_dir):
              if filename.endswith('.html') and filename != 'index.html':
                  file_path = os.path.join(target_dir, filename)
                  try:
                      file_stats = os.stat(file_path)
                  except:
                      continue
                  
                  name_parts = filename[:-5].split('_')
                  title = name_parts[0] if len(name_parts) > 0 else 'æœªçŸ¥ä¹¦ç±'
                  author = name_parts[1] if len(name_parts) > 1 else 'ä½šå'
                  category = name_parts[2] if len(name_parts) > 2 else 'æœªåˆ†ç±»'
                  
                  if category not in category_stats:
                      category_stats[category] = 0
                  category_stats[category] += 1
                  
                  book = {
                      'title': title,
                      'author': author,
                      'category': category,
                      'file': filename,
                      'size': file_stats.st_size,
                      'lastModified': int(file_stats.st_mtime * 1000)
                  }
                  books.append(book)

          category_list = []
          for cat, count in sorted(category_stats.items()):
              category_list.append({
                  'name': cat,
                  'count': count,
                  'icon': category_icons.get(cat, 'ğŸ“˜')
              })

          result = {
              'totalBooks': len(books),
              'totalCategories': len(category_stats),
              'categories': sorted(list(category_stats.keys())),
              'categoryStats': category_list,
              'books': books,
              'lastUpdated': int(datetime.now().timestamp() * 1000)
          }

          with open(os.path.join(target_dir, 'books.json'), 'w', encoding='utf-8') as f:
              json.dump(result, f, ensure_ascii=False, indent=2)
          EOF
          
          python generate_books4me.py

      - name: ç›´æ¥æäº¤å¹¶æ¨é€ï¼ˆæ— pullï¼Œé€‚é…å•äººåœºæ™¯ï¼‰
        run: |
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ğŸŒŸ æ ¸å¿ƒä¿®æ”¹ï¼šç›´æ¥æ·»åŠ æ–‡ä»¶ï¼Œæ— pull/merge/stash
          git add books4me/books.json
          
          # ä»…å½“æœ‰ä¿®æ”¹æ—¶æäº¤
          if git diff --cached --quiet; then
              echo "âœ… æ— æ›´æ–°ï¼Œè·³è¿‡æäº¤"
          else
              git commit -m "è‡ªåŠ¨æ›´æ–°books4me/books.json - $(date +'%Y-%m-%d %H:%M:%S')"
              # ç›´æ¥æ¨é€ï¼Œæ— pullæ­¥éª¤
              git push origin ${{ github.ref_name }}
              echo "âœ… books.json æ¨é€æˆåŠŸ"
          fi
