# å·¥ä½œæµåç§°ï¼šæ›´æ–°books4meç›®å½•ä¹¦ç±åˆ—è¡¨
name: æ›´æ–°books4meç›®å½•ä¹¦ç±åˆ—è¡¨

# è§¦å‘æ¡ä»¶ï¼šæ¨é€HTMLæ–‡ä»¶ã€æ‰‹åŠ¨è§¦å‘ã€æ¯6å°æ—¶è‡ªåŠ¨è§¦å‘
on:
  push:
    branches: [main, master]  # åŒæ—¶é€‚é…main/masteråˆ†æ”¯
    paths:
      - 'books4me/*.html'       # ç›‘æ§books4meä¸‹çš„HTMLæ–‡ä»¶
      - 'books4me/**/*.html'    # ç›‘æ§books4meå­æ–‡ä»¶å¤¹çš„HTMLæ–‡ä»¶
  workflow_dispatch:            # ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼ˆå…œåº•ç”¨ï¼‰
  schedule:
    - cron: '0 */6 * * *'       # æ¯6å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡

# æ‰§è¡Œçš„ä»»åŠ¡
jobs:
  update-books4me-list:
    runs-on: ubuntu-latest  # ä½¿ç”¨Ubuntuæœ€æ–°ç‰ˆè¿è¡Œç¯å¢ƒ
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆæ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…å†²çªï¼‰
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…³é”®ï¼šæ‹‰å–å®Œæ•´çš„ä»“åº“å†å²ï¼Œè§£å†³æ‹‰å–å†²çª

      # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒï¼ˆç”ŸæˆJSONéœ€è¦Pythonï¼‰
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # ç¨³å®šçš„Pythonç‰ˆæœ¬

      # æ­¥éª¤3ï¼šç”Ÿæˆbooks4me/books.jsonæ–‡ä»¶ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
      - name: ç”Ÿæˆä¹¦ç±åˆ—è¡¨JSONï¼ˆbooks4meï¼‰
        run: |
          # ç¡®ä¿books4meç›®å½•å­˜åœ¨ï¼ˆé¿å…ç©ºç›®å½•æŠ¥é”™ï¼‰
          mkdir -p books4me
          
          # ç¼–å†™Pythonè„šæœ¬ï¼ˆå†…åµŒåˆ°å·¥ä½œæµï¼Œæ— éœ€å•ç‹¬æ–‡ä»¶ï¼‰
          cat > generate_books4me.py << 'EOF'
          import os
          import json
          from datetime import datetime

          # åˆ†ç±»å›¾æ ‡æ˜ å°„ï¼ˆå¯æ ¹æ®ä½ çš„åˆ†ç±»æ‰©å±•ï¼‰
          category_icons = {
              'ç«¥è¯': 'ğŸ§š', 'ç§‘å¹»': 'ğŸš€', 'æ–‡å­¦': 'ğŸ“š', 
              'å†å²': 'ğŸ›ï¸', 'å“²å­¦': 'ğŸ¤”', 'è¯—æ­Œ': 'ğŸ­',
              'ä¼ è®°': 'ğŸ“œ', 'æŠ€æœ¯': 'ğŸ’»', 'è‰ºæœ¯': 'ğŸ¨',
              'å°è¯´': 'ğŸ“–', 'æ•£æ–‡': 'âœï¸', 'ç§‘æ™®': 'ğŸ”¬',
              'å¿ƒç†å­¦': 'ğŸ§ ', 'ç»æµå­¦': 'ğŸ’°', 'ç®¡ç†å­¦': 'ğŸ“Š',
              'æœªåˆ†ç±»': 'ğŸ“˜'
          }

          # ç›®æ ‡ç›®å½•
          target_dir = 'books4me'
          books = []
          category_stats = {}

          # éå†æ‰€æœ‰HTMLæ–‡ä»¶ï¼ˆæ’é™¤index.htmlï¼‰
          for filename in os.listdir(target_dir):
              if filename.endswith('.html') and filename != 'index.html':
                  file_path = os.path.join(target_dir, filename)
                  # è·å–æ–‡ä»¶ä¿¡æ¯ï¼ˆå¤§å°ã€ä¿®æ”¹æ—¶é—´ï¼‰
                  try:
                      file_stats = os.stat(file_path)
                  except:
                      continue  # è·³è¿‡æ— æ³•è¯»å–çš„æ–‡ä»¶
                  
                  # è§£ææ–‡ä»¶åï¼šæ ‡é¢˜_ä½œè€…_åˆ†ç±».htmlï¼ˆå®¹é”™å¤„ç†ï¼‰
                  name_parts = filename[:-5].split('_')  # å»æ‰.htmlåç¼€
                  title = name_parts[0] if len(name_parts) > 0 else 'æœªçŸ¥ä¹¦ç±'
                  author = name_parts[1] if len(name_parts) > 1 else 'ä½šå'
                  category = name_parts[2] if len(name_parts) > 2 else 'æœªåˆ†ç±»'
                  
                  # ç»Ÿè®¡åˆ†ç±»æ•°é‡
                  if category not in category_stats:
                      category_stats[category] = 0
                  category_stats[category] += 1
                  
                  # æ„å»ºå•æœ¬ä¹¦ç±ä¿¡æ¯
                  book = {
                      'title': title,
                      'author': author,
                      'category': category,
                      'file': filename,
                      'size': file_stats.st_size,
                      'lastModified': int(file_stats.st_mtime * 1000)  # è½¬æ¯«ç§’æ—¶é—´æˆ³
                  }
                  books.append(book)

          # æ„å»ºåˆ†ç±»ç»Ÿè®¡ï¼ˆå¸¦å›¾æ ‡ï¼‰
          category_list = []
          for cat, count in sorted(category_stats.items()):
              category_list.append({
                  'name': cat,
                  'count': count,
                  'icon': category_icons.get(cat, 'ğŸ“˜')
              })

          # ç”Ÿæˆæœ€ç»ˆJSONæ•°æ®
          result = {
              'totalBooks': len(books),
              'totalCategories': len(category_stats),
              'categories': sorted(list(category_stats.keys())),
              'categoryStats': category_list,
              'books': books,
              'lastUpdated': int(datetime.now().timestamp() * 1000)
          }

          # å†™å…¥JSONæ–‡ä»¶ï¼ˆç¡®ä¿UTF-8ç¼–ç ï¼‰
          with open(os.path.join(target_dir, 'books.json'), 'w', encoding='utf-8') as f:
              json.dump(result, f, ensure_ascii=False, indent=2)
          EOF
          
          # æ‰§è¡ŒPythonè„šæœ¬ï¼Œç”Ÿæˆbooks.json
          python generate_books4me.py

      # æ­¥éª¤4ï¼šæäº¤å¹¶æ¨é€æ›´æ”¹ï¼ˆä¿®å¤å†²çªæ ¸å¿ƒæ­¥éª¤ï¼‰
      - name: æäº¤å¹¶æ¨é€æ›´æ”¹ï¼ˆä¿®å¤å†²çªï¼‰
        run: |
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯ï¼ˆå¿…é¡»ï¼Œå¦åˆ™æ— æ³•æäº¤ï¼‰
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ğŸŒŸ æ ¸å¿ƒä¿®å¤ï¼šè§£å†³ã€Œæœªæäº¤ä¿®æ”¹å¯¼è‡´pullå¤±è´¥ã€çš„é—®é¢˜
          # 1. æš‚å­˜ç”Ÿæˆçš„books.jsonï¼ˆé¿å…æ‹‰å–æ—¶å†²çªï¼‰
          git add books4me/books.json
          git stash push -m "æš‚å­˜books4me/books.json" || true
          
          # 2. æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç ï¼ˆè‡ªåŠ¨åˆå¹¶ï¼Œå¤±è´¥åˆ™å¿½ç•¥ï¼‰
          git pull origin ${{ github.ref_name }} --rebase --autostash || true
          
          # 3. æ¢å¤æš‚å­˜çš„ä¿®æ”¹
          git stash pop || true
          
          # 4. é‡æ–°æš‚å­˜æ–‡ä»¶
          git add books4me/books.json
          
          # 5. ä»…å½“æœ‰ä¿®æ”¹æ—¶æäº¤ï¼ˆé¿å…ç©ºæäº¤æŠ¥é”™ï¼‰
          if git diff --cached --quiet; then
              echo "âœ… æ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹ï¼Œè·³è¿‡æäº¤"
          else
              git commit -m "è‡ªåŠ¨æ›´æ–°books4me/books.json - $(date +'%Y-%m-%d %H:%M:%S')"
              # æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“
              git push origin ${{ github.ref_name }}
              echo "âœ… books4me/books.json å·²æˆåŠŸæ›´æ–°å¹¶æ¨é€"
          fi
